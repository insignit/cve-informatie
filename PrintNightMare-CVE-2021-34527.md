# Printnightmare CVE-2021-34527

Afgelopen dagen is er veel te doen rondom de ‘Printnightmare’ CVE. Er wordt veel gespeculeerd en geadviseerd rondom deze CVE. Bij Insign.it hebben we de tijd genomen om een duidelijk document te maken met de informatie die op dit moment voorhanden is en de tests die we uitgevoerd hebben. 

Voorop stellend is het lastig om één generiek advies te geven. Alle situaties verschillen vanwege de rollen en (OS)versies van werkstations/servers. Ook is er een lokale manier van misbruik mogelijk als remote welke beide een eigen workaround benodigen. 

Is de situatie onduidelijk óf wilt u graag sparren over wat deze CVE voor u betekend en welke acties er nodig zijn? Neem dan contact op met onze Servicedesk zodat één van onze engineers een gericht advies kan uitbrengen voor uw omgeving. 

  **Note** Zorg altijd voor een goede backup.  
  **Note:** Adviezen blijven wijzigen, dit advies is een moment opname.

 
## Advies 

In elk scenario is het uitschakelen van de Print Spooler Service de beste ‘work around’ tot Microsoft met goede patches komt. Dus indien mogelijk disable en stop op alle Windows systemen (servers en clients) de Print Spooler Service. Door middel van het uitschakelen ben je niet meer vulnerable en zijn er geen aanvullende stappen nodig. 

Mocht het noodzakelijk zijn om de Print Spooler Service toch ingeschakeld te laten dan zijn er een aantal stappen nodig om misbruik te mitigeren. In essentie kan dit via Group Policies. De basis hiervan kan insign.it aanmaken of aanleveren. 

- Zorg voor een policy waarmee de Print Spooler Service wordt uitgeschakeld én de Service wordt disabled op alle servers/clients waar printing niet nodig is. 

Zorg voor een tweede policy waarmee je de servers/clients (behalve print server) raakt die de volgende settings doorvoerd: 

- Computer Policy: “Allow print spooler to accept client connections” op Disabled. 

Indien point and print gebruikt wordt en de point and print registry keys/policy aanwezig is dien je onderstaande aanvullende wijziging door te
voeren op zowel servers, werkstations of print server

- User Policy: “Point and Print Resrictions” op Enabled en zet beide settings op ‘Show warning and elevation prompt’ 


## Patching 

Er zijn patches vanuit Microsoft beschikbaar gesteld. Nog niet voor alle OS types en builds.  
Deze lost het remote kwetsbare stuk op maar lokaal blijf je nog kwetsbaar. Als je de patch geïnstalleerd hebt gelden dus nog dezelfde “Point and Print Resrictions” Settings indien point and print is geconfigureerd.

Patch in alle gevallen je Print Server(s) omdat hier de “Allow print spooler to accept client connections” niet gebruikt kan worden om Remote misbruik te voorkomen zonder dat je het print proces volledig stopt. 

Patch óók de overige werkstations/servers indien nodig in combinatie met de “Point and Print Resrictions” waar printing noodzakelijk is om berscherming te bieden tegen lokaal én extern misbruik. 

 
- Configureer na de Patch de RestrictDriverInstallationToAdministrators register sleutel op waarde 1 zodat Non-administrators geen drivers kunnen installeren.  

 
**Note**: De Patch vereist een reboot van het systeem bij installeren als ook het verwijderen. 

**Note**: Er is aangetoond dat de Patch een negatief effect heeft op Zebra Printers.  

 
Meer info over de Patch: 

https://support.microsoft.com/en-us/topic/kb5005010-restricting-installation-of-new-printer-drivers-after-applying-the-july-6-2021-updates-31b91c02-05bc-4ada-a7ea-183b129578a7 

 

## Flowcharts 

Er zijn een aantal flowcharts in omloop ter illustratie hoe te bepalen wanneer je kwetsbaar bent. 
**Note** Echter ook deze zijn niet altijd helemaal actueel
![flowchart Benjamin Delphi](https://pbs.twimg.com/media/E5nvlQOXIAcp9ql?format=png&name=large)
Source: Benjamin Delphi


![Flowchart Will Dormann](https://pbs.twimg.com/media/E5y7h36WYAMPzBo?format=jpg&name=large)  
Source: Will Dormann